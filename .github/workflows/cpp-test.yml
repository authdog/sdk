name: C++ SDK Tests

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - '.github/workflows/cpp-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - '.github/workflows/cpp-test.yml'

env:
  BUILD_TYPE: Release
  TEST_TIMEOUT: 300

jobs:
  test:
    name: Test C++ SDK
    # runs-on: ubuntu-latest
    runs-on: blacksmith-4vcpu-ubuntu-2404

    
    strategy:
      fail-fast: false
      matrix:
        compiler: [
          # gcc,
          clang
          ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libcurl4-openssl-dev \
          libssl-dev \
          pkg-config

    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          sudo apt-get install -y clang
        fi

    - name: Configure CMake
      run: |
        cd cpp
        BUILD_DIR="build-${{ matrix.compiler }}"
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          cmake -B $BUILD_DIR \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DAUTHDOG_BUILD_TESTS=ON \
            -DAUTHDOG_BUILD_EXAMPLES=ON
        else
          cmake -B $BUILD_DIR \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_C_COMPILER=gcc \
            -DAUTHDOG_BUILD_TESTS=ON \
            -DAUTHDOG_BUILD_EXAMPLES=ON
        fi

    - name: Build
      run: |
        cd cpp
        cmake --build $BUILD_DIR --config ${{ env.BUILD_TYPE }} --parallel

    - name: Run tests
      run: |
        cd cpp
        ctest --test-dir $BUILD_DIR \
          --output-on-failure \
          --timeout ${{ env.TEST_TIMEOUT }}

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.compiler }}
        path: cpp/$BUILD_DIR/Testing/

    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-${{ matrix.compiler }}
        path: cpp/$BUILD_DIR/

